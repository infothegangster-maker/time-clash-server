<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <!-- Revert to Standard Viewport for JS Scaling -->
    <meta name="viewport"
        content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Time Clash Arena</title>
    <script>
        // SHARK STRATEGY: JS-Based Fixed Design Resolution (Like Flutter ScreenUtil)
        // Forces the app to scale exactly to 414px width on ANY device.
        (function () {
            function setScale() {
                const designWidth = 414;
                const innerW = window.innerWidth;
                const innerH = window.innerHeight;
                const scale = innerW / designWidth;

                document.body.style.zoom = scale;
                // CRITICAL FIX: Correct Height for Vertical Centering
                // When zoomed, vh units distort. We set explicit pixel height to match viewport.
                document.body.style.height = (innerH / scale) + 'px';
                document.body.style.width = '414px'; // Force fixed width in zoomed context
            }
            window.addEventListener('resize', setScale);
            window.addEventListener('DOMContentLoaded', setScale);

            // Immediate run
            const scale = window.innerWidth / 414;
            document.write('<style>body { zoom: ' + scale + '; height: ' + (window.innerHeight / scale) + 'px; width: 414px; }</style>');
        })();
    </script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Fredoka+One&family=Roboto+Mono:wght@500;700&display=swap');
        @import url('https://fonts.googleapis.com/css2?family=Teko:wght@600&display=swap');

        :root {
            --bg-grad: linear-gradient(135deg, #0f172a 0%, #1e293b 100%);
            --panel-bg: #1e293b;
            --primary: #FFD700;
            --accent: #3b82f6;
            --success: #22c55e;
            --text-main: #f8fafc;
        }

        * {
            box-sizing: border-box;
            user-select: none;
            -webkit-user-select: none;
        }

        body {
            background: var(--bg-grad);
            color: var(--text-main);
            font-family: 'Fredoka One', cursive;
            height: 100vh;
            margin: 0;
            overflow: hidden;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
        }

        .screen-container {
            position: relative;
            width: 100%;
            max-width: 450px;
            padding: 20px;
            /* Flex Grow to fill space between Top & Bottom Ads */
            flex: 1;
            height: auto;
            /* Allow dynamic height */
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            margin: auto;
            /* Horizontally center */
            margin-top: 0;
            /* REMOVED OFFSET */
        }

        .ui-panel {
            background: var(--panel-bg);
            border-radius: 25px;
            padding: 30px 20px;
            width: 100%;
            text-align: center;
            box-shadow: 0 20px 50px rgba(0, 0, 0, 0.5);
            position: relative;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        h1 {
            margin: 0;
            font-size: 2.5rem;
            color: #fff;
            line-height: 1.2;
            margin-bottom: 10px;
        }

        /* --- BUTTONS --- */
        .btn {
            background: var(--accent);
            border: none;
            color: white;
            padding: 18px 40px;
            font-family: inherit;
            font-size: 1.5rem;
            border-radius: 12px;
            cursor: pointer;
            transition: 0.1s;
            width: 100%;
            box-shadow: 0 8px 0 #1d4ed8;
            margin-top: 15px;
            position: relative;
            overflow: hidden;
            text-transform: uppercase;
        }

        .btn:active {
            transform: translateY(4px);
            box-shadow: 0 4px 0 #1d4ed8;
        }

        .btn.stop {
            background: #ef4444;
            box-shadow: 0 8px 0 #b91c1c;
        }

        .btn.stop:active {
            box-shadow: 0 4px 0 #b91c1c;
        }

        .btn.retry {
            background: #3b82f6;
            box-shadow: 0 8px 0 #1d4ed8;
        }

        .btn:disabled {
            background: #475569;
            box-shadow: none;
            cursor: not-allowed;
            color: #94a3b8;
        }

        /* --- SCREENS --- */
        .screen {
            display: none;
            width: 100%;
            flex-direction: column;
            align-items: center;
        }

        .screen.active {
            display: flex;
            animation: fadeIn 0.3s ease-out;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        /* --- TIMER AREA --- */
        .timer-container {
            background: #0f172a;
            border-radius: 15px;
            padding: 25px 20px;
            margin-bottom: 20px;
            margin-top: 50px;
            /* Pushed down as requested */
            position: relative;
            overflow: hidden;
            display: flex;
            flex-direction: column;
            align-items: center;
            border: 1px solid #334155;
            box-shadow: inset 0 0 20px rgba(0, 0, 0, 0.5);
        }

        .comparison-row {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 15px;
            width: 100%;
            margin-bottom: 8px;
        }

        .comp-label {
            color: #64748b;
            font-size: 0.9rem;
            width: 70px;
            text-align: right;
            font-weight: bold;
            letter-spacing: 1px;
            font-family: sans-serif;
        }

        .comp-value {
            font-family: 'Roboto Mono', monospace;
            font-size: 2.4rem;
            font-weight: 700;
            letter-spacing: 3px;
            color: #fff;
            text-align: left;
            width: 190px;
            text-shadow: 0 0 10px rgba(255, 255, 255, 0.1);
        }

        .target-val {
            color: var(--primary);
        }

        .digit-match {
            color: var(--success);
            text-shadow: 0 0 10px rgba(34, 197, 94, 0.5);
        }

        .digit-miss {
            color: #ef4444;
            animation: blink 0.5s infinite;
            text-shadow: 0 0 10px rgba(239, 68, 68, 0.5);
        }

        @keyframes blink {
            50% {
                opacity: 0.5;
            }
        }

        .diff-badge {
            background: rgba(239, 68, 68, 0.2);
            color: #ef4444;
            padding: 5px 15px;
            border-radius: 20px;
            font-size: 0.9rem;
            font-weight: bold;
            margin-top: 15px;
            display: none;
            font-family: sans-serif;
            border: 1px solid rgba(239, 68, 68, 0.3);
        }

        .hearts-container {
            display: flex;
            justify-content: center;
            gap: 8px;
            margin-bottom: 20px;
        }

        .heart {
            font-size: 1.5rem;
            transition: 0.3s;
        }

        .heart.lost {
            opacity: 0.2;
            transform: scale(0.5);
            filter: grayscale(100%);
        }

        .pulse {
            animation: pulse 0.5s ease-in-out 3;
        }

        @keyframes pulse {

            0%,
            100% {
                transform: scale(1);
            }

            50% {
                transform: scale(1.05);
            }
        }

        /* BOUNCY START EFFECT */
        .bounce-start {
            animation: bounceStart 0.5s ease-out;
        }

        @keyframes bounceStart {
            0% {
                transform: scale(1);
            }

            20% {
                transform: scale(1.08);
            }

            40% {
                transform: scale(0.95);
            }

            60% {
                transform: scale(1.04);
            }

            80% {
                transform: scale(0.98);
            }

            100% {
                transform: scale(1);
            }
        }

        /* Timer Glow on Start */
        .timer-active {
            border-color: var(--accent) !important;
            box-shadow: inset 0 0 20px rgba(0, 0, 0, 0.5), 0 0 15px rgba(59, 130, 246, 0.4);
        }

        /* YOU Timer Blink Animation (0.5s on Start) */
        .timer-blink {
            animation: timerBlink 0.5s ease-in-out;
        }

        @keyframes timerBlink {
            0% {
                opacity: 1;
                text-shadow: 0 0 10px rgba(255, 255, 255, 0.1);
            }

            25% {
                opacity: 0.3;
                text-shadow: 0 0 20px rgba(59, 130, 246, 0.8), 0 0 30px rgba(59, 130, 246, 0.6);
            }

            50% {
                opacity: 1;
                text-shadow: 0 0 15px rgba(255, 255, 255, 0.4), 0 0 25px rgba(59, 130, 246, 0.7);
            }

            75% {
                opacity: 0.4;
                text-shadow: 0 0 20px rgba(59, 130, 246, 0.8), 0 0 30px rgba(59, 130, 246, 0.6);
            }

            100% {
                opacity: 1;
                text-shadow: 0 0 10px rgba(255, 255, 255, 0.1);
            }
        }

        /* BACK BUTTON */
        /* BACK BUTTON */
        .back-btn {
            position: absolute;
            top: 15px;
            left: 15px;
            background: none;
            border: none;
            color: #64748b;
            font-size: 1.8rem;
            cursor: pointer;
            z-index: 10;
            padding: 5px;
            line-height: 1;
        }

        .back-btn:hover {
            color: #fff;
        }

        /* TOAST */
        #message-toast {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(0, 0, 0, 0.95);
            padding: 20px 30px;
            border-radius: 15px;
            color: white;
            border: 1px solid #444;
            z-index: 200;
            display: none;
            text-align: center;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.8);
            font-family: sans-serif;
        }


        /* Congratulations Animation */
        @keyframes celebrate {
            0% {
                transform: scale(0) rotate(0deg);
                opacity: 0;
            }

            50% {
                transform: scale(1.2) rotate(180deg);
                opacity: 1;
            }

            100% {
                transform: scale(1) rotate(360deg);
                opacity: 1;
            }
        }

        @keyframes confetti {
            0% {
                transform: translateY(0) translateX(0) rotate(0deg);
                opacity: 1;
            }

            100% {
                transform: translateY(-200px) translateX(var(--move-x)) rotate(720deg);
                opacity: 0;
            }
        }

        .congrats-animation {
            animation: celebrate 0.8s ease-out;
        }

        .confetti {
            position: absolute;
            width: 10px;
            height: 10px;
            background: #FFD700;
            animation: confetti 2s ease-out forwards;
        }

        /* Stats Container (Above Hearts) */
        .stats-container {
            display: flex;
            justify-content: center;
            gap: 10px;
            margin-bottom: 15px;
        }

        .rank-badge,
        .best-badge,
        .tournament-badge {
            font-family: 'Roboto Mono', monospace;
            font-size: 0.8rem;
            padding: 6px 12px;
            background: rgba(0, 0, 0, 0.6);
            border-radius: 12px;
            color: #94a3b8;
            border: 1px solid rgba(255, 255, 255, 0.15);
            backdrop-filter: blur(4px);
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.3);
        }

        .tournament-badge {
            color: #FFD700;
            border-color: rgba(255, 215, 0, 0.3);
            min-width: 100px;
        }

        .new-record-anim {
            animation: recordPulse 1s infinite;
            color: #FFD700 !important;
            border-color: #FFD700 !important;
        }

        @keyframes recordPulse {
            0% {
                transform: scale(1);
                box-shadow: 0 0 0 rgba(255, 215, 0, 0);
            }

            50% {
                transform: scale(1.05);
                box-shadow: 0 0 20px rgba(255, 215, 0, 0.5);
            }

            100% {
                transform: scale(1);
                box-shadow: 0 0 0 rgba(255, 215, 0, 0);
            }
        }

        /* REFILL POPUP */
        #refill-popup {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.85);
            /* Dark overlay */
            z-index: 500;
            display: none;
            /* Hidden by default */
            flex-direction: column;
            justify-content: center;
            align-items: center;
            backdrop-filter: blur(5px);
        }

        .refill-card {
            background: #1e293b;
            border-radius: 20px;
            padding: 30px;
            width: 90%;
            max-width: 400px;
            text-align: center;
            border: 1px solid rgba(255, 255, 255, 0.1);
            box-shadow: 0 20px 50px rgba(0, 0, 0, 0.5);
        }

        .refill-title {
            font-size: 2rem;
            color: #ef4444;
            /* Red for alert */
            margin-bottom: 10px;
            text-transform: uppercase;
        }

        .refill-btn {
            width: 100%;
            padding: 15px;
            border-radius: 12px;
            border: none;
            color: #fff;
            font-family: 'Teko', sans-serif;
            font-size: 1.5rem;
            margin-bottom: 15px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            transition: transform 0.1s;
        }

        .refill-btn:active {
            transform: scale(0.98);
        }

        .btn-12 {
            background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);
            box-shadow: 0 4px 0 #1d4ed8;
        }

        .btn-20 {
            background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);
            box-shadow: 0 4px 0 #b45309;
        }

        /* TOP SCORES POPUP */
        #top-scores-popup {
            position: fixed;
            top: 0; left: 0;
            width: 100%; height: 100%;
            background: rgba(0,0,0,0.88);
            z-index: 600;
            display: none;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            backdrop-filter: blur(6px);
        }
        #top-scores-popup .ts-card {
            background: linear-gradient(135deg, #1e293b, #0f172a);
            border-radius: 20px;
            padding: 24px 20px;
            width: 90%;
            max-width: 380px;
            max-height: 70vh;
            border: 1px solid rgba(139,92,246,0.3);
            box-shadow: 0 20px 60px rgba(0,0,0,0.6), 0 0 30px rgba(139,92,246,0.15);
            display: flex;
            flex-direction: column;
        }
        #top-scores-popup .ts-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 16px;
            flex-shrink: 0;
        }
        #top-scores-popup .ts-title {
            font-family: 'Teko', sans-serif;
            font-size: 1.6rem;
            color: #FFD700;
            font-weight: 700;
            letter-spacing: 2px;
        }
        #top-scores-popup .ts-close {
            background: rgba(255,255,255,0.1);
            border: none;
            color: #94a3b8;
            font-size: 1.4rem;
            width: 36px; height: 36px;
            border-radius: 50%;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        #top-scores-popup .ts-list {
            flex: 1;
            overflow-y: auto;
            min-height: 0;
        }
        #top-scores-popup .ts-row {
            display: flex;
            align-items: center;
            padding: 10px 12px;
            margin-bottom: 6px;
            background: rgba(255,255,255,0.03);
            border-radius: 10px;
            border: 1px solid rgba(255,255,255,0.05);
        }
        #top-scores-popup .ts-row.is-you {
            background: rgba(59,130,246,0.15);
            border-color: rgba(59,130,246,0.4);
        }
        #top-scores-popup .ts-rank {
            width: 36px;
            font-size: 1.1rem;
            text-align: center;
            flex-shrink: 0;
        }
        #top-scores-popup .ts-name {
            flex: 1;
            font-size: 0.95rem;
            font-weight: 600;
            color: #fff;
            padding-left: 8px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        #top-scores-popup .ts-score {
            font-family: 'Roboto Mono', monospace;
            font-size: 0.9rem;
            color: #FFD700;
            font-weight: 700;
            flex-shrink: 0;
        }
        #top-scores-popup .ts-empty {
            text-align: center;
            color: #64748b;
            padding: 30px 10px;
            font-size: 1rem;
        }
        #top-scores-popup .ts-refresh {
            margin-top: 12px;
            text-align: center;
            flex-shrink: 0;
        }
        #top-scores-popup .ts-refresh-btn {
            background: linear-gradient(135deg, #6366f1, #8b5cf6);
            border: none;
            color: #fff;
            padding: 8px 20px;
            border-radius: 10px;
            font-family: 'Teko', sans-serif;
            font-size: 1rem;
            font-weight: 600;
            letter-spacing: 1px;
            cursor: pointer;
        }

        /* REPURPOSED TRYS DISPLAY (Badge Style) */
        #game-trys-display {
            font-family: 'Roboto Mono', monospace;
            font-size: 0.8rem;
            padding: 6px 12px;
            background: rgba(0, 0, 0, 0.6);
            border-radius: 12px;
            color: #fff;
            border: 1px solid rgba(255, 255, 255, 0.15);
            backdrop-filter: blur(4px);
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.3);
            /* Reset absolute positioning */
            position: static;
            display: inline-block;
        }
    </style>
</head>

<body>

    <!-- TOP AD (Same as Home) -->
    <div id="game-ad-top" style="width: 100%; height: 150px; background: transparent; flex-shrink: 0;"></div>

    <!-- LOADING / MESSAGE TOAST -->
    <div id="message-toast">Connecting to Cloud...</div>



    <!-- REFILL POPUP -->
    <div id="refill-popup">
        <div class="refill-card">
            <div class="refill-title">OUT OF HEALTH!</div>
            <div style="color: #94a3b8; margin-bottom: 15px;">Watch an Ad or Wait to Refill</div>

            <!-- WATCH 1 AD = +20 HEALTH -->
            <button class="refill-btn btn-20" onclick="TrysManager.watchAd()">
                <span>üì∫ Watch Ad</span>
                <span style="background: rgba(0,0,0,0.2); padding: 2px 8px; border-radius: 4px;">+20 ‚ù§Ô∏è</span>
            </button>

            <!-- REFILL TIMER -->
            <div id="refill-timer-display" style="color: #facc15; font-size: 1.1rem; margin: 12px 0 8px; font-family: 'Roboto Mono', monospace;">
                ‚è≥ Refill in: --:--
            </div>

            <button onclick="goHome()"
                style="background: transparent; border: none; color: #64748b; margin-top: 10px; cursor: pointer;">Go
                Home</button>
        </div>
    </div>

    <!-- TOP SCORES POPUP -->
    <div id="top-scores-popup">
        <div class="ts-card">
            <div class="ts-header">
                <div class="ts-title">üèÜ LIVE LEADERBOARD</div>
                <button class="ts-close" onclick="closeTopScores()">‚úï</button>
            </div>
            <div class="ts-list" id="top-scores-list">
                <div class="ts-empty">Loading...</div>
            </div>
            <div class="ts-refresh">
                <button class="ts-refresh-btn" onclick="fetchTopScores()">üîÑ REFRESH</button>
            </div>
        </div>
    </div>

    <div class="screen-container">

        <!-- SCREEN: TIMER GAME -->
        <div id="screen-hacking" class="screen active">
            <div class="ui-panel">
                <button class="back-btn" onclick="goHome()">‚Üê</button>

                <!-- Stats (Rank & Best & Trys) -->
                <div class="stats-container">
                    <div class="tournament-badge" id="tournament-timer">ENDS: --:--</div>
                    <div class="rank-badge" id="rank-display">RANK: --</div>
                    <div class="best-badge" id="best-display">BEST: --ms</div>
                    <div id="game-trys-display">‚ù§Ô∏è --</div>
                    <button onclick="openTopScores()" style="
                        font-family: 'Roboto Mono', monospace;
                        font-size: 0.8rem;
                        padding: 6px 10px;
                        background: rgba(255,215,0,0.15);
                        border-radius: 12px;
                        color: #FFD700;
                        border: 1px solid rgba(255,215,0,0.3);
                        cursor: pointer;
                        display: inline-flex;
                        align-items: center;
                        gap: 4px;
                    ">üìä TOP</button>
                </div>

                <div class="timer-container" id="timer-box">

                    <!-- UNIFIED VIEW -->
                    <div id="unified-view" style="width: 100%;">
                        <div class="comparison-row">
                            <span class="comp-label">TARGET</span>
                            <span class="comp-value target-val" id="display-target">--.---</span>
                        </div>
                        <div class="comparison-row">
                            <span class="comp-label">YOU</span>
                            <span class="comp-value" id="display-timer">00.000</span>
                        </div>
                    </div>

                    <div class="diff-badge" id="diff-badge">OFF BY 0.000</div>

                </div>

                <div id="hack-status"
                    style="height: 60px; font-size: 1.1rem; color: #94a3b8; font-weight: bold; line-height: 1.3;">
                    Waiting for Server...
                </div>

                <button id="hack-btn" class="btn" disabled>LOADING...</button>
            </div>
        </div>

        <!-- SCREEN: RESULT -->
        <div id="screen-result" class="screen">
            <div class="ui-panel" style="position: relative; overflow: hidden;">
                <h1 id="result-title" class="congrats-animation">CONGRATULATIONS!</h1>
                <div id="result-icon" style="font-size: 5rem; margin: 10px 0;">üéâ</div>
                <div id="result-message" style="margin: 10px 0; font-size: 1.2rem; color: #94a3b8;"></div>

                <button class="btn retry" onclick="Game.resetToGame()">TRY AGAIN</button>
            </div>
        </div>
    </div>

    <div id="game-ad-placeholder" style="width: 100%; height: 150px; background: transparent;"></div>

    <!-- SOCKET.IO -->
    <script src="https://cdn.socket.io/4.7.5/socket.io.min.js"></script>
    <script src="ad_manager.js"></script>

    <script>
        // --- CLOUD CONFIG ---
        const SERVER_URL = "https://time-clash-server.onrender.com";
        let socket = null;

        // CLEANUP & GO BACK TO TOURNAMENT
        function goHome() {
            window.location.href = 'tournament.html';
        }

        document.addEventListener('deviceready', () => {
            const w = window.innerWidth;

            // 1. Show TOP Ad (Same as Home)
            setTimeout(() => {
                AdManager.showNativeAd('game-ad-top', 'home_top', w, 150);
            }, 500);

            // 2. Show BOTTOM Ad (Same as Home)
            setTimeout(() => {
                AdManager.showNativeAd('game-ad-placeholder', 'home_bottom', w, 150);
            }, 1000);
        });

        // Show Interstitial Ads Removed per user request
        function showStrategicAd() {
            // Logic removed
        }

        // --- TRYS MANAGER (Server-Synced, Anti-Cheat) ---
        const TrysManager = {
            trys: 0,
            mode: 'practice',
            regenInterval: null,

            init() {
                this.mode = localStorage.getItem('game_mode') || 'practice';

                if (this.mode === 'practice') {
                    document.getElementById('game-trys-display').innerText = "PRACTICE MODE";
                    document.getElementById('game-trys-display').style.color = "#4ade80";
                } else {
                    // Sync health from server
                    this.syncFromServer();
                }
            },

            async syncFromServer() {
                const userId = localStorage.getItem('tc_user_id');
                if (!userId) return;
                try {
                    const res = await fetch(`${SERVER_URL}/api/health?userId=${encodeURIComponent(userId)}`);
                    const data = await res.json();
                    this.trys = data.health || 0;
                    localStorage.setItem('user_trys', this.trys);
                    this.updateUI();

                    // Start refill timer display if health is 0
                    if (this.trys <= 0 && data.regenRemaining) {
                        this.startRefillTimer(data.regenRemaining);
                    }
                } catch (e) {
                    this.trys = parseInt(localStorage.getItem('user_trys') || '0');
                    this.updateUI();
                }
            },

            updateUI() {
                if (this.mode === 'tournament') {
                    const el = document.getElementById('game-trys-display');
                    if (el) {
                        el.innerText = `‚ù§Ô∏è ${this.trys}`;
                        el.style.color = this.trys > 0 ? "#fff" : "#ef4444";
                    }
                }
            },

            setHealth(h) {
                this.trys = h;
                localStorage.setItem('user_trys', this.trys);
                this.updateUI();
                // Stop refill timer if health restored
                if (h > 0 && this.regenInterval) {
                    clearInterval(this.regenInterval);
                    this.regenInterval = null;
                }
            },

            checkTrys() {
                if (this.mode === 'practice') return true;
                if (this.trys <= 0) {
                    this.showRefillPopup();
                    return false;
                }
                return true;
            },

            consumeTry() {
                if (this.mode === 'practice') return true;
                // Server deducts health on 'st' event ‚Äî just check locally
                if (this.trys > 0) {
                    return true;
                } else {
                    this.showRefillPopup();
                    return false;
                }
            },

            showRefillPopup() {
                document.getElementById('refill-popup').style.display = 'flex';
                // Start refill timer display
                this.syncFromServer();
            },

            startRefillTimer(remainingMs) {
                if (this.regenInterval) clearInterval(this.regenInterval);
                let remaining = remainingMs;
                const timerEl = document.getElementById('refill-timer-display');

                const tick = () => {
                    if (remaining <= 0 || this.trys > 0) {
                        if (timerEl) timerEl.innerText = '‚úÖ Refill Ready!';
                        clearInterval(this.regenInterval);
                        this.regenInterval = null;
                        // Claim refill from server
                        this.claimRefill();
                        return;
                    }
                    const m = Math.floor(remaining / 60000);
                    const s = Math.floor((remaining % 60000) / 1000);
                    if (timerEl) timerEl.innerText = `‚è≥ Refill in: ${m}:${String(s).padStart(2, '0')}`;
                    remaining -= 1000;
                };

                tick();
                this.regenInterval = setInterval(tick, 1000);
            },

            async claimRefill() {
                const userId = localStorage.getItem('tc_user_id');
                if (!userId) return;
                try {
                    const res = await fetch(`${SERVER_URL}/api/health/refill`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ userId })
                    });
                    const data = await res.json();
                    if (data.success) {
                        this.setHealth(data.health);
                        document.getElementById('refill-popup').style.display = 'none';
                        Hacking.showToast('‚ù§Ô∏è Health Refilled! +20');
                        setTimeout(() => Hacking.hideToast(), 1500);
                        setTimeout(() => Game.resetToGame(), 800);
                    }
                } catch (e) { /* retry on next tick */ }
            },

            // Watch 1 Ad = +20 health (server-validated)
            watchAd() {
                AdManager.showRewardVideoAd().then(async (success) => {
                    if (success) {
                        const userId = localStorage.getItem('tc_user_id');
                        try {
                            const res = await fetch(`${SERVER_URL}/api/health/ad-reward`, {
                                method: 'POST',
                                headers: { 'Content-Type': 'application/json' },
                                body: JSON.stringify({ userId })
                            });
                            const data = await res.json();
                            if (data.success) {
                                this.setHealth(data.health);
                            }
                        } catch (e) {
                            // Fallback: give health locally
                            this.setHealth(20);
                        }
                        document.getElementById('refill-popup').style.display = 'none';
                        Hacking.showToast('+20 Health Added! Starting...');
                        setTimeout(() => Hacking.hideToast(), 1500);
                        setTimeout(() => Game.resetToGame(), 1000);
                    }
                });
            }
        };

        const Game = {
            state: 'HACK',
            bestMiss: Infinity,

            init() {
                TrysManager.init();
                Hacking.init();
                this.connectCloud();
            },

            connectCloud() {
                Hacking.showToast("Connecting to Cloud...");

                socket = io(SERVER_URL, {
                    transports: ['websocket', 'polling']
                });

                socket.on('connect', () => {
                    console.log("Connected to Cloud Server");
                    Hacking.showToast("Connected!");
                    setTimeout(() => Hacking.hideToast(), 1000);

                    const savedId = localStorage.getItem('tc_user_id');
                    const email = localStorage.getItem('tc_email');
                    const username = localStorage.getItem('tc_username');
                    const idToken = localStorage.getItem('tc_id_token');

                    // Enforce login - no guest access
                    if (!savedId || !idToken) {
                        Hacking.showToast('Please login first!');
                        setTimeout(() => window.location.href = 'login.html', 1500);
                        return;
                    }

                    socket.emit('ig', {
                        u: savedId,
                        e: email,
                        n: username,
                        t: idToken,
                        m: TrysManager.mode === 'tournament' ? 't' : 'p'
                    });
                });

                socket.on('connect_error', (err) => {
                    Hacking.showToast("Connection Error...");
                    console.error(err);
                });

                socket.on('grd', (data) => {
                    Hacking.target = data.t / 1000;
                    const tStr = Game.formatTime(data.t);
                    Hacking.elements.displayTarget.innerText = tStr.replace(':', '.');

                    const r = data.r === -1 ? 'UNRANKED' : data.r;
                    const b = data.b === -1 ? 'NA' : data.b;

                    document.getElementById('rank-display').innerText = `RANK: #${r}`;
                    document.getElementById('best-display').innerText = `BEST: ${b}${b !== 'NA' ? 'ms' : ''}`;

                    // START TOURNAMENT TIMER - Only if time left > 0 (not in leaderboard time)
                    if (data.tl && data.tl > 0) {
                        Game.startTournamentTimer(data.tl);
                    } else {
                        // Leaderboard time - redirect to tournament page
                        const timerDisplay = document.getElementById('tournament-timer');
                        if (timerDisplay) timerDisplay.innerText = "LEADERBOARD";
                        // Redirect after a short delay
                        setTimeout(() => {
                            window.location.href = 'tournament.html';
                        }, 1000);
                    }

                    Hacking.resetView();
                    Hacking.readyToPlay();
                });

                socket.on('t', (ms) => {
                    if (Hacking.state === 'RUNNING' || Hacking.state === 'STOPPING') {
                        const seconds = Math.floor(ms / 1000);
                        const milliseconds = Math.floor(ms % 1000);
                        const timeStr = `${String(seconds).padStart(2, '0')}.${String(milliseconds).padStart(3, '0')}`;
                        Hacking.elements.displayTimer.innerText = timeStr;
                    }
                });

                // Server health events (anti-cheat)
                socket.on('no_health', () => {
                    TrysManager.setHealth(0);
                    // Reset Hacking state back to IDLE (server rejected the 'st')
                    if (Hacking.state === 'RUNNING') {
                        Hacking.state = 'IDLE';
                        Hacking.elements.btn.innerText = "START";
                        Hacking.elements.btn.className = "btn start";
                        Hacking.elements.btn.disabled = false;
                        Hacking.elements.status.innerText = "No health!";
                        Hacking.elements.displayTimer.innerText = "00.000";
                        Hacking.elements.timerBox.classList.remove('timer-active');
                    }
                    TrysManager.showRefillPopup();
                });
                socket.on('health_update', (data) => {
                    TrysManager.setHealth(data.health);
                });

                socket.on('gr', (data) => {
                    Hacking.handleServerResult(data);
                    // Sync Timer - Only if time left > 0 (not in leaderboard time)
                    if (data.rem && data.rem > 0) {
                        Game.startTournamentTimer(data.rem);
                    } else {
                        // Leaderboard time - redirect to tournament page
                        const timerDisplay = document.getElementById('tournament-timer');
                        if (timerDisplay) timerDisplay.innerText = "LEADERBOARD";
                        // Redirect after a short delay
                        setTimeout(() => {
                            window.location.href = 'tournament.html';
                        }, 1000);
                    }
                });
            },

            startHack() {
                this.state = 'HACK';
                this.switchScreen('screen-hacking');
            },

            formatTime(ms) {
                const s = Math.floor(ms / 1000);
                const m = Math.floor(ms % 1000);
                return `${String(s).padStart(2, '0')}.${String(m).padStart(3, '0')}`;
            },

            finishLevel(success, message) {
                this.state = 'RESULT';
                this.switchScreen('screen-result');
                const title = document.getElementById('result-title');
                const msg = document.getElementById('result-message');
                const icon = document.getElementById('result-icon');
                const panel = document.querySelector('#screen-result .ui-panel');

                if (success) {
                    // Remove old animation class and add new one
                    title.classList.remove('congrats-animation');
                    void title.offsetWidth; // Trigger reflow
                    title.classList.add('congrats-animation');

                    title.innerText = "CONGRATULATIONS!";
                    title.style.color = "#22c55e";
                    icon.innerText = "üéâ";
                    msg.innerHTML = "PERFECT TIMING!<br>You got it EXACT!";

                    // Create confetti effect
                    this.createConfetti(panel);
                } else {
                    title.innerText = "SO CLOSE!";
                    title.style.color = "#ef4444";
                    icon.innerText = "üò¢";
                    msg.innerHTML = message;
                }

                // --- HIGH REVENUE: SHOW AD ON RESULT ---
                // "Natural Break" - Best time for engagement
                const w = window.innerWidth;
                // Force a fresh refresh of the bottom ad to catch the user's eye
                AdManager.showNativeAd('game-ad-placeholder', 'home_bottom', w, 150);
                // ---------------------------------------
            },

            createConfetti(container) {
                const colors = ['#FFD700', '#FF6B6B', '#4ECDC4', '#45B7D1', '#FFA07A', '#98D8C8'];
                for (let i = 0; i < 50; i++) {
                    const confetti = document.createElement('div');
                    confetti.className = 'confetti';
                    const randomX = (Math.random() - 0.5) * 150; // -75px to 75px
                    confetti.style.setProperty('--move-x', randomX + 'px');
                    confetti.style.left = Math.random() * 100 + '%';
                    confetti.style.top = '20%';
                    confetti.style.background = colors[Math.floor(Math.random() * colors.length)];
                    confetti.style.animationDelay = Math.random() * 0.8 + 's';
                    confetti.style.animationDuration = (Math.random() * 1 + 1.5) + 's';
                    confetti.style.width = Math.random() * 10 + 8 + 'px';
                    confetti.style.height = confetti.style.width;
                    confetti.style.borderRadius = Math.random() > 0.5 ? '50%' : '0%';
                    container.appendChild(confetti);

                    setTimeout(() => confetti.remove(), 3000);
                }
            },

            resetToGame() {
                // Health check will happen when user clicks START button, not here
                // Clear skip flag if exists
                if (localStorage.getItem('skip_health_check') === 'true') {
                    localStorage.removeItem('skip_health_check');
                }

                const savedId = localStorage.getItem('tc_user_id');
                const email = localStorage.getItem('tc_email');
                const username = localStorage.getItem('tc_username');
                const idToken = localStorage.getItem('tc_id_token');

                // Enforce login - no guest access
                if (!savedId || !idToken) {
                    Hacking.showToast('Please login first!');
                    setTimeout(() => window.location.href = 'login.html', 1500);
                    return;
                }

                socket.emit('ig', {
                    u: savedId,
                    e: email,
                    n: username,
                    t: idToken,
                    m: TrysManager.mode === 'tournament' ? 't' : 'p'
                });

                this.startHack();
                Hacking.resetView();
                Hacking.elements.btn.innerText = "LOADING...";
                Hacking.elements.btn.disabled = true;
                Hacking.elements.btn.className = "btn";
            },

            colorizeDigits(targetStr, playerStr) {
                let html = "";
                if (targetStr.length !== playerStr.length) return playerStr;

                for (let i = 0; i < targetStr.length; i++) {
                    if (targetStr[i] === playerStr[i]) {
                        html += `<span class="digit-match">${playerStr[i]}</span>`;
                    } else {
                        html += `<span class="digit-miss">${playerStr[i]}</span>`;
                    }
                }
                return html;
            },

            switchScreen(id) {
                document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
                document.getElementById(id).classList.add('active');
            },

            tournamentInterval: null,
            startTournamentTimer(msLeft) {
                if (this.tournamentInterval) clearInterval(this.tournamentInterval);

                const display = document.getElementById('tournament-timer');

                // Don't start timer if time left is 0 or negative (leaderboard time)
                if (!msLeft || msLeft <= 0) {
                    if (display) display.innerText = "LEADERBOARD";
                    return;
                }

                let secondsRemaining = Math.floor(msLeft / 1000);

                const updateDisplay = () => {
                    if (secondsRemaining <= 0) {
                        display.innerText = "LEADERBOARD";
                        clearInterval(this.tournamentInterval);
                        // Play time ended - redirect to tournament page
                        window.location.href = 'tournament.html';
                        return;
                    }

                    const m = Math.floor(secondsRemaining / 60);
                    const s = secondsRemaining % 60;
                    display.innerText = `ENDS: ${String(m).padStart(2, '0')}:${String(s).padStart(2, '0')}`;
                    secondsRemaining--;
                };

                updateDisplay(); // Immediate update
                this.tournamentInterval = setInterval(updateDisplay, 1000);
            }
        };

        const Hacking = {
            target: 0,
            state: 'IDLE',
            elements: {
                btn: document.getElementById('hack-btn'),
                status: document.getElementById('hack-status'),
                timerBox: document.getElementById('timer-box'),
                displayTarget: document.getElementById('display-target'),
                displayTimer: document.getElementById('display-timer'),
                diffBadge: document.getElementById('diff-badge'),
                toast: document.getElementById('message-toast')
            },

            init() {
                this.resetView();
                this.setupInputs();
            },

            showToast(msg) {
                this.elements.toast.innerText = msg;
                this.elements.toast.style.display = 'block';
            },

            hideToast() {
                this.elements.toast.style.display = 'none';
            },

            resetView() {
                this.elements.displayTimer.innerHTML = "00.000";
                this.elements.displayTimer.style.color = "#fff";
                this.elements.timerBox.style.borderColor = "#334155";
                this.elements.timerBox.classList.remove('bounce-start', 'timer-active');
                this.elements.diffBadge.style.display = "none";
                this.elements.status.innerHTML = "Waiting for Server...";
            },

            readyToPlay() {
                this.state = 'IDLE';
                this.elements.btn.innerText = "START";
                this.elements.btn.disabled = false;
                this.elements.btn.className = "btn";
                this.elements.status.innerHTML = "Hit STOP at exact target!";
                this.elements.status.style.color = "#94a3b8";
            },

            setupInputs() {
                this.elements.btn.onclick = () => this.handleInput();
            },

            handleInput() {
                if (Game.state !== 'HACK') return;
                if (!socket) return;

                if (this.state === 'IDLE') {
                    // BEFORE START - CHECK TRYS!
                    if (!TrysManager.consumeTry()) return;

                    // START
                    this.state = 'RUNNING';
                    this.elements.btn.innerText = "STOP";
                    this.elements.btn.className = "btn stop";
                    this.elements.status.innerText = "WAIT FOR IT...";

                    this.elements.timerBox.classList.remove('bounce-start');
                    void this.elements.timerBox.offsetWidth;
                    this.elements.timerBox.classList.add('bounce-start', 'timer-active');
                    setTimeout(() => {
                        this.elements.timerBox.classList.remove('bounce-start');
                    }, 500);

                    this.elements.displayTimer.classList.remove('timer-blink');
                    void this.elements.displayTimer.offsetWidth;
                    this.elements.displayTimer.classList.add('timer-blink');
                    setTimeout(() => {
                        this.elements.displayTimer.classList.remove('timer-blink');
                    }, 500);

                    socket.emit('st');

                } else if (this.state === 'RUNNING') {
                    this.state = 'STOPPING';
                    this.elements.btn.disabled = true;
                    this.elements.btn.innerText = "PROCESSING...";
                    this.elements.status.innerText = "Calculating...";
                    socket.emit('sp');
                }
            },

            handleServerResult(data) {
                const diffMs = data.d;
                const playerTimeStr = Game.formatTime(data.ft);
                const targetStr = Game.formatTime(data.tt);
                const rank = data.r;
                const bestScore = data.bs;
                const newRecord = data.nr === 1;
                const isWin = data.w === 1;

                this.state = 'IDLE';
                this.elements.displayTimer.innerText = playerTimeStr;

                if (rank) document.getElementById('rank-display').innerText = `RANK: #${rank}`;
                if (bestScore) document.getElementById('best-display').innerText = `BEST: ${bestScore}ms`;

                if (isWin) {
                    this.elements.displayTimer.style.color = "#22c55e";
                    Game.finishLevel(true, "PERFECT TIMING!");
                } else {
                    // Handle Loss

                    if (diffMs < Game.bestMiss) Game.bestMiss = diffMs;

                    this.elements.displayTimer.innerHTML = Game.colorizeDigits(targetStr, playerTimeStr);

                    this.elements.diffBadge.style.display = "inline-block";
                    this.elements.diffBadge.innerText = `OFF BY ${diffMs}ms`;

                    this.elements.timerBox.style.borderColor = "#ef4444";
                    this.elements.timerBox.classList.add('pulse');
                    setTimeout(() => this.elements.timerBox.classList.remove('pulse'), 1000);

                    this.elements.btn.innerText = "TRY AGAIN";
                    this.elements.btn.className = "btn retry";
                    this.elements.btn.disabled = false;

                    // Specific logic for message if needed?
                    let msg = "";
                    if (newRecord) {
                        msg = `üî• NEW HIGH SCORE! üî•<br><b>You jumped to Rank #${rank}!</b>`;
                        this.elements.diffBadge.classList.add('new-record-anim');
                        this.elements.diffBadge.innerText = `NEW BEST: ${diffMs}ms!`;
                    } else if (diffMs < 10) {
                        msg = `üò± OFF BY A WHISKER!<br><b>Just ${diffMs}ms difference!</b>`;
                    } else {
                        msg = `üí™ Getting closer!<br><b>Watch the last digit carefully!</b>`;
                    }
                    this.elements.status.innerHTML = msg;
                    this.elements.status.style.color = newRecord ? "#FFD700" : "#ef4444";
                }
            }
        };

        // --- TOP SCORES FEATURE ---
        async function fetchTopScores() {
            const listEl = document.getElementById('top-scores-list');
            if (!listEl) return;
            listEl.innerHTML = '<div class="ts-empty">Loading...</div>';

            try {
                const userId = localStorage.getItem('tc_user_id') || '';
                const res = await fetch(`${SERVER_URL}/api/tournament-top-scores?count=10&userId=${encodeURIComponent(userId)}`);
                const data = await res.json();

                if (!data.scores || data.scores.length === 0) {
                    listEl.innerHTML = '<div class="ts-empty">No scores yet. Be the first!</div>';
                    return;
                }

                const medals = ['ü•á','ü•à','ü•â'];
                listEl.innerHTML = data.scores.map(p => {
                    const medal = medals[p.rank - 1] || `#${p.rank}`;
                    const scoreStr = p.score + 'ms';
                    return `
                        <div class="ts-row ${p.isYou ? 'is-you' : ''}">
                            <div class="ts-rank">${medal}</div>
                            <div class="ts-name">${p.isYou ? 'üë§ ' : ''}${p.name}</div>
                            <div class="ts-score">${scoreStr}</div>
                        </div>
                    `;
                }).join('');
            } catch (e) {
                listEl.innerHTML = '<div class="ts-empty">Failed to load. Try again.</div>';
            }
        }

        function openTopScores() {
            document.getElementById('top-scores-popup').style.display = 'flex';
            fetchTopScores();
        }

        function closeTopScores() {
            document.getElementById('top-scores-popup').style.display = 'none';
        }

        Game.init();

    </script>
    <script src="heartbeat.js"></script>
</body>

</html>