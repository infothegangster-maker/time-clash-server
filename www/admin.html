<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Time Clash - Admin Panel</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap');
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Inter', sans-serif;
            background: linear-gradient(135deg, #0f172a 0%, #1e293b 100%);
            color: #fff;
            min-height: 100vh;
            padding: 20px;
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
        }
        
        .header {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 15px;
            padding: 20px 30px;
            margin-bottom: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        .header h1 {
            font-size: 2rem;
            background: linear-gradient(135deg, #FFD700, #f59e0b);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }
        
        .refresh-btn {
            background: linear-gradient(135deg, #3b82f6, #2563eb);
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            transition: transform 0.2s;
        }
        
        .refresh-btn:hover {
            transform: scale(1.05);
        }
        
        .refresh-btn:active {
            transform: scale(0.95);
        }
        
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }
        
        .stat-card {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 12px;
            padding: 20px;
            border: 1px solid rgba(255, 255, 255, 0.1);
            transition: transform 0.2s;
        }
        
        .stat-card:hover {
            transform: translateY(-5px);
            background: rgba(255, 255, 255, 0.08);
        }
        
        .stat-label {
            font-size: 0.9rem;
            color: #94a3b8;
            margin-bottom: 8px;
            text-transform: uppercase;
            letter-spacing: 1px;
        }
        
        .stat-value {
            font-size: 2rem;
            font-weight: 700;
            color: #FFD700;
        }
        
        .section {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 15px;
            padding: 25px;
            margin-bottom: 20px;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        .section-title {
            font-size: 1.5rem;
            font-weight: 700;
            margin-bottom: 20px;
            color: #fff;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .table-container {
            overflow-x: auto;
        }
        
        table {
            width: 100%;
            border-collapse: collapse;
        }
        
        th, td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        th {
            background: rgba(255, 255, 255, 0.1);
            font-weight: 600;
            color: #FFD700;
            text-transform: uppercase;
            font-size: 0.85rem;
            letter-spacing: 1px;
        }
        
        tr:hover {
            background: rgba(255, 255, 255, 0.05);
        }
        
        .badge {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: 600;
        }
        
        .badge-success {
            background: rgba(34, 197, 94, 0.2);
            color: #22c55e;
            border: 1px solid rgba(34, 197, 94, 0.3);
        }
        
        .badge-warning {
            background: rgba(245, 158, 11, 0.2);
            color: #f59e0b;
            border: 1px solid rgba(245, 158, 11, 0.3);
        }
        
        .badge-info {
            background: rgba(59, 130, 246, 0.2);
            color: #3b82f6;
            border: 1px solid rgba(59, 130, 246, 0.3);
        }
        
        .loading {
            text-align: center;
            padding: 40px;
            color: #94a3b8;
        }
        
        .error {
            background: rgba(239, 68, 68, 0.1);
            color: #ef4444;
            padding: 15px;
            border-radius: 8px;
            border: 1px solid rgba(239, 68, 68, 0.3);
            margin: 10px 0;
        }
        
        .timestamp {
            font-size: 0.85rem;
            color: #64748b;
        }
        
        .auto-refresh {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 20px;
        }
        
        .toggle-switch {
            position: relative;
            width: 50px;
            height: 24px;
        }
        
        .toggle-switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }
        
        .slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #475569;
            transition: .4s;
            border-radius: 24px;
        }
        
        .slider:before {
            position: absolute;
            content: "";
            height: 18px;
            width: 18px;
            left: 3px;
            bottom: 3px;
            background-color: white;
            transition: .4s;
            border-radius: 50%;
        }
        
        input:checked + .slider {
            background-color: #3b82f6;
        }
        
        input:checked + .slider:before {
            transform: translateX(26px);
        }
        
        .search-box {
            width: 100%;
            padding: 10px 15px;
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 8px;
            color: white;
            margin-bottom: 15px;
        }
        
        .search-box::placeholder {
            color: #64748b;
        }
        
        .grid-2 {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
        }
        
        @media (max-width: 768px) {
            .grid-2 {
                grid-template-columns: 1fr;
            }
            .stats-grid {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>‚ö° Time Clash Admin Panel</h1>
            <div>
                <button class="refresh-btn" onclick="loadAllData()">üîÑ Refresh All</button>
            </div>
        </div>
        
        <div class="auto-refresh">
            <label class="toggle-switch">
                <input type="checkbox" id="autoRefresh" checked>
                <span class="slider"></span>
            </label>
            <span>Auto Refresh (5s)</span>
        </div>
        
        <!-- STATS CARDS -->
        <div class="stats-grid">
            <div class="stat-card">
                <div class="stat-label">Active Users</div>
                <div class="stat-value" id="stat-active-users">-</div>
            </div>
            <div class="stat-card">
                <div class="stat-label">Active Sessions</div>
                <div class="stat-value" id="stat-sessions">-</div>
            </div>
            <div class="stat-card">
                <div class="stat-label">Running Games</div>
                <div class="stat-value" id="stat-games">-</div>
            </div>
            <div class="stat-card">
                <div class="stat-label">Current Tournament</div>
                <div class="stat-value" id="stat-tournament-id" style="font-size: 1.2rem;">-</div>
            </div>
            <div class="stat-card">
                <div class="stat-label">Tournament Participants</div>
                <div class="stat-value" id="stat-participants">-</div>
            </div>
            <div class="stat-card">
                <div class="stat-label">Server Uptime</div>
                <div class="stat-value" id="stat-uptime" style="font-size: 1.2rem;">-</div>
            </div>
        </div>
        
        <!-- ACTIVE USERS -->
        <div class="section">
            <div class="section-title">üë• Active Users (Firebase - Real-time)</div>
            <input type="text" class="search-box" id="search-users" placeholder="Search users by email, username, or ID..." onkeyup="filterUsers()">
            <div class="table-container">
                <table id="active-users-table">
                    <thead>
                        <tr>
                            <th>User ID</th>
                            <th>Email</th>
                            <th>Username</th>
                            <th>Connected At</th>
                            <th>Last Activity</th>
                            <th>Status</th>
                        </tr>
                    </thead>
                    <tbody id="active-users-body">
                        <tr><td colspan="6" class="loading">Loading...</td></tr>
                    </tbody>
                </table>
            </div>
        </div>
        
        <!-- CURRENT TOURNAMENT -->
        <div class="section">
            <div class="section-title">üèÜ Current Tournament</div>
            <div id="current-tournament-info" class="loading">Loading...</div>
            <div class="table-container" id="current-tournament-table" style="display: none;">
                <table>
                    <thead>
                        <tr>
                            <th>Rank</th>
                            <th>User ID</th>
                            <th>Email</th>
                            <th>Username</th>
                            <th>Score (ms)</th>
                        </tr>
                    </thead>
                    <tbody id="current-tournament-body"></tbody>
                </table>
            </div>
        </div>
        
        <!-- TOURNAMENT HISTORY -->
        <div class="section">
            <div class="section-title">üìú Tournament History</div>
            <div class="table-container">
                <table id="tournament-history-table">
                    <thead>
                        <tr>
                            <th>Tournament ID</th>
                            <th>Date</th>
                            <th>Participants</th>
                            <th>Winner</th>
                            <th>Winner Score</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="tournament-history-body">
                        <tr><td colspan="6" class="loading">Loading...</td></tr>
                    </tbody>
                </table>
            </div>
        </div>
        
        <!-- SYSTEM STATS -->
        <div class="section">
            <div class="section-title">‚öôÔ∏è System Statistics</div>
            <div class="grid-2">
                <div>
                    <h3 style="margin-bottom: 15px; color: #FFD700;">Memory Usage</h3>
                    <div id="memory-stats" class="loading">Loading...</div>
                </div>
                <div>
                    <h3 style="margin-bottom: 15px; color: #FFD700;">Server Info</h3>
                    <div id="server-info" class="loading">Loading...</div>
                </div>
            </div>
        </div>
        
        <!-- ALL USERS -->
        <div class="section">
            <div class="section-title">üë§ All Firebase Users (All Registered Users)</div>
            <input type="text" class="search-box" id="search-all-users" placeholder="Search all users..." onkeyup="filterAllUsers()">
            <div class="table-container">
                <table id="all-users-table">
                    <thead>
                        <tr>
                            <th>User ID</th>
                            <th>Email</th>
                            <th>Display Name</th>
                            <th>Status</th>
                            <th>Email Verified</th>
                            <th>Last Sign In</th>
                        </tr>
                    </thead>
                    <tbody id="all-users-body">
                        <tr><td colspan="6" class="loading">Loading...</td></tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>
    
    <script>
        // Use Cloudflare Worker for admin panel
        const WORKER_URL = "https://timeclash.raj829266.workers.dev";
        const BACKEND_URL = "https://time-clash-server.onrender.com";
        const SERVER_URL = WORKER_URL; // Use Cloudflare Worker
        
        // Log which server is being used
        console.log("üîó Admin Panel Server URL:", SERVER_URL);
        console.log("üì° Using Cloudflare Worker:", SERVER_URL === WORKER_URL);
        
        let autoRefreshInterval = null;
        let allUsersData = [];
        let activeUsersData = [];
        
        // Format timestamp
        function formatTime(timestamp) {
            if (!timestamp) return 'N/A';
            const date = new Date(timestamp);
            return date.toLocaleString();
        }
        
        // Format duration
        function formatDuration(seconds) {
            const hours = Math.floor(seconds / 3600);
            const minutes = Math.floor((seconds % 3600) / 60);
            const secs = Math.floor(seconds % 60);
            return `${hours}h ${minutes}m ${secs}s`;
        }
        
        // Format bytes
        function formatBytes(bytes) {
            if (bytes === 0) return '0 Bytes';
            const k = 1024;
            const sizes = ['Bytes', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return Math.round(bytes / Math.pow(k, i) * 100) / 100 + ' ' + sizes[i];
        }
        
        // Load Active Users from Firebase
        async function loadActiveUsers() {
            try {
                const url = `${SERVER_URL}/api/admin/firebase-active-users`;
                console.log("üì° Fetching active users from:", url);
                const res = await fetch(url);
                const data = await res.json();
                
                if (data.error) {
                    document.getElementById('active-users-body').innerHTML = 
                        `<tr><td colspan="6" class="error">Error: ${data.error}<br><small>${data.message || ''}</small></td></tr>`;
                    console.error('Active users error:', data);
                    return;
                }
                
                activeUsersData = data.users || [];
                document.getElementById('stat-active-users').textContent = data.count || 0;
                
                const tbody = document.getElementById('active-users-body');
                if (activeUsersData.length === 0) {
                    const msg = data.message || 'No users currently active on the app';
                    tbody.innerHTML = `<tr><td colspan="6" style="text-align: center; color: #94a3b8;">${msg}</td></tr>`;
                    return;
                }
                
                tbody.innerHTML = activeUsersData.map(user => `
                    <tr>
                        <td>${user.uid ? user.uid.substring(0, 20) + '...' : 'N/A'}</td>
                        <td>${user.email || 'N/A'}</td>
                        <td>${user.displayName || 'Guest'}</td>
                        <td class="timestamp">${user.connectedAt ? formatTime(user.connectedAt) : 'N/A'}</td>
                        <td class="timestamp">${user.lastActivity ? formatTime(user.lastActivity) : 'N/A'}</td>
                        <td>${user.isGuest ? '<span class="badge badge-warning">Guest</span>' : '<span class="badge badge-success">Active</span>'}</td>
                    </tr>
                `).join('');
            } catch (e) {
                document.getElementById('active-users-body').innerHTML = 
                    `<tr><td colspan="6" class="error">Failed to load: ${e.message}</td></tr>`;
            }
        }
        
        // Load Current Tournament
        async function loadCurrentTournament() {
            try {
                const url = `${SERVER_URL}/api/admin/current-tournament`;
                console.log("üì° Fetching current tournament from:", url);
                const res = await fetch(url);
                const data = await res.json();
                
                if (data.error) {
                    document.getElementById('current-tournament-info').innerHTML = 
                        `<div class="error">Error: ${data.error}</div>`;
                    return;
                }
                
                document.getElementById('stat-participants').textContent = data.participantCount || 0;
                document.getElementById('stat-tournament-id').textContent = data.tournamentId || 'N/A';
                
                const infoDiv = document.getElementById('current-tournament-info');
                const playTimeLeft = Math.floor(data.playTimeLeft / 1000);
                const minutes = Math.floor(playTimeLeft / 60);
                const seconds = playTimeLeft % 60;
                
                infoDiv.innerHTML = `
                    <div style="margin-bottom: 15px;">
                        <strong>Tournament ID:</strong> ${data.tournamentId}<br>
                        <strong>Participants:</strong> ${data.participantCount}<br>
                        <strong>Play Time Left:</strong> ${minutes}m ${seconds}s
                    </div>
                `;
                
                const tbody = document.getElementById('current-tournament-body');
                if (data.participants && data.participants.length > 0) {
                    document.getElementById('current-tournament-table').style.display = 'block';
                    tbody.innerHTML = data.participants.map((p, index) => `
                        <tr>
                            <td><strong>#${index + 1}</strong></td>
                            <td>${p.userId.substring(0, 20)}...</td>
                            <td>${p.email}</td>
                            <td>${p.username}</td>
                            <td><strong>${p.score}ms</strong></td>
                        </tr>
                    `).join('');
                } else {
                    document.getElementById('current-tournament-table').style.display = 'none';
                    infoDiv.innerHTML += '<div style="color: #94a3b8; margin-top: 10px;">No participants yet</div>';
                }
            } catch (e) {
                document.getElementById('current-tournament-info').innerHTML = 
                    `<div class="error">Failed to load: ${e.message}</div>`;
            }
        }
        
        // Load Tournament History
        async function loadTournamentHistory() {
            try {
                const url = `${SERVER_URL}/api/admin/tournament-history`;
                console.log("üì° Fetching tournament history from:", url);
                const res = await fetch(url);
                const data = await res.json();
                
                if (data.error) {
                    document.getElementById('tournament-history-body').innerHTML = 
                        `<tr><td colspan="6" class="error">Error: ${data.error}</td></tr>`;
                    return;
                }
                
                const tbody = document.getElementById('tournament-history-body');
                if (!data.history || data.history.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="6" style="text-align: center; color: #94a3b8;">No tournament history</td></tr>';
                    return;
                }
                
                tbody.innerHTML = data.history.map(tournament => {
                    const date = new Date(tournament.ts);
                    const winner = tournament.winners && tournament.winners.length > 0 ? tournament.winners[0] : null;
                    return `
                        <tr>
                            <td>${tournament.id}</td>
                            <td class="timestamp">${date.toLocaleString()}</td>
                            <td>${tournament.participantCount || 0}</td>
                            <td>${winner ? (winner.u?.substring(0, 15) + '...' || 'N/A') : 'N/A'}</td>
                            <td>${winner ? winner.s + 'ms' : 'N/A'}</td>
                            <td>
                                <button onclick="viewTournamentDetails('${tournament.id}')" 
                                    style="background: #3b82f6; color: white; border: none; padding: 5px 10px; border-radius: 5px; cursor: pointer;">
                                    View Details
                                </button>
                            </td>
                        </tr>
                    `;
                }).join('');
            } catch (e) {
                document.getElementById('tournament-history-body').innerHTML = 
                    `<tr><td colspan="6" class="error">Failed to load: ${e.message}</td></tr>`;
            }
        }
        
        // Load System Stats
        async function loadSystemStats() {
            try {
                const url = `${SERVER_URL}/api/admin/system-stats`;
                console.log("üì° Fetching system stats from:", url);
                const res = await fetch(url);
                const data = await res.json();
                
                if (data.error) {
                    return;
                }
                
                document.getElementById('stat-sessions').textContent = data.activeSessions || 0;
                document.getElementById('stat-games').textContent = data.runningGames || 0;
                document.getElementById('stat-uptime').textContent = formatDuration(data.serverUptime || 0);
                
                // Memory Stats
                if (data.memoryUsage) {
                    const mem = data.memoryUsage;
                    document.getElementById('memory-stats').innerHTML = `
                        <div style="margin-bottom: 10px;"><strong>Heap Used:</strong> ${formatBytes(mem.heapUsed)}</div>
                        <div style="margin-bottom: 10px;"><strong>Heap Total:</strong> ${formatBytes(mem.heapTotal)}</div>
                        <div style="margin-bottom: 10px;"><strong>RSS:</strong> ${formatBytes(mem.rss)}</div>
                        <div><strong>External:</strong> ${formatBytes(mem.external)}</div>
                    `;
                }
                
                // Server Info
                document.getElementById('server-info').innerHTML = `
                    <div style="margin-bottom: 10px;"><strong>Current Tournament:</strong> ${data.currentTournament || 'N/A'}</div>
                    <div style="margin-bottom: 10px;"><strong>Total Tournaments:</strong> ${data.totalTournaments || 0}</div>
                    <div style="margin-bottom: 10px;"><strong>Active Users:</strong> ${data.activeUsers || 0}</div>
                    <div class="timestamp">Last Updated: ${formatTime(data.timestamp)}</div>
                `;
            } catch (e) {
                console.error('Failed to load system stats:', e);
            }
        }
        
        // Load All Users from Firebase
        async function loadAllUsers() {
            try {
                const url = `${SERVER_URL}/api/admin/firebase-users`;
                console.log("üì° Fetching all Firebase users from:", url);
                const res = await fetch(url);
                const data = await res.json();
                
                if (data.error) {
                    let errorMsg = data.error;
                    let helpText = '';
                    
                    if (data.error === 'Not Found') {
                        helpText = 'Worker endpoint not found. Make sure worker is deployed correctly.';
                    } else if (data.error.includes('FIREBASE_SERVICE_ACCOUNT')) {
                        helpText = 'Make sure FIREBASE_SERVICE_ACCOUNT is set in Cloudflare Worker Secrets (not Environment Variables).';
                    } else if (data.details) {
                        helpText = data.details;
                    } else {
                        helpText = 'Check Cloudflare Worker logs and environment variables.';
                    }
                    
                    document.getElementById('all-users-body').innerHTML = 
                        `<tr><td colspan="6" class="error"><strong>Error:</strong> ${errorMsg}<br><small>${helpText}</small>${data.availableEndpoints ? '<br><small>Available endpoints: ' + data.availableEndpoints.join(', ') + '</small>' : ''}</td></tr>`;
                    console.error('Firebase users error:', data);
                    return;
                }
                
                allUsersData = data.users || [];
                
                // Update stats
                document.getElementById('stat-active-users').textContent = data.activeCount || 0;
                
                const tbody = document.getElementById('all-users-body');
                if (allUsersData.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="6" style="text-align: center; color: #94a3b8;">No Firebase users found. Users will appear here after they login.</td></tr>';
                    return;
                }
                
                tbody.innerHTML = allUsersData.map(user => `
                    <tr>
                        <td>${user.uid ? user.uid.substring(0, 20) + '...' : 'N/A'}</td>
                        <td>${user.email || 'N/A'}</td>
                        <td>${user.displayName || 'Guest'}</td>
                        <td>${user.isActive ? '<span class="badge badge-success">Active</span>' : '<span class="badge badge-warning">Inactive</span>'}</td>
                        <td>${user.emailVerified ? '<span class="badge badge-info">Verified</span>' : '<span class="badge badge-warning">Unverified</span>'}</td>
                        <td class="timestamp">${user.lastSignInTime && user.lastSignInTime !== 'Never' ? formatTime(new Date(user.lastSignInTime).getTime()) : 'Never'}</td>
                    </tr>
                `).join('');
            } catch (e) {
                document.getElementById('all-users-body').innerHTML = 
                    `<tr><td colspan="6" class="error">Failed to load: ${e.message}</td></tr>`;
            }
        }
        
        // Filter functions
        function filterUsers() {
            const search = document.getElementById('search-users').value.toLowerCase();
            const rows = document.querySelectorAll('#active-users-body tr');
            rows.forEach(row => {
                if (row.querySelector('td.error') || row.querySelector('td.loading')) return;
                const text = row.textContent.toLowerCase();
                row.style.display = text.includes(search) ? '' : 'none';
            });
        }
        
        function filterAllUsers() {
            const search = document.getElementById('search-all-users').value.toLowerCase();
            const rows = document.querySelectorAll('#all-users-body tr');
            rows.forEach(row => {
                if (row.querySelector('td.error') || row.querySelector('td.loading')) return;
                const text = row.textContent.toLowerCase();
                row.style.display = text.includes(search) ? '' : 'none';
            });
        }
        
        // View Tournament Details
        function viewTournamentDetails(tournamentId) {
            alert(`Tournament Details for: ${tournamentId}\n\nFull details will be shown in a modal (to be implemented)`);
        }
        
        // Load All Data
        async function loadAllData() {
            await Promise.all([
                loadActiveUsers(),
                loadCurrentTournament(),
                loadTournamentHistory(),
                loadSystemStats(),
                loadAllUsers()
            ]);
        }
        
        // Auto Refresh Toggle
        document.getElementById('autoRefresh').addEventListener('change', function(e) {
            if (e.target.checked) {
                autoRefreshInterval = setInterval(loadAllData, 5000);
            } else {
                if (autoRefreshInterval) {
                    clearInterval(autoRefreshInterval);
                    autoRefreshInterval = null;
                }
            }
        });
        
        // Show which server is being used
        window.addEventListener('DOMContentLoaded', function() {
            const serverInfo = document.createElement('div');
            serverInfo.style.cssText = 'position: fixed; top: 10px; right: 10px; background: #1e293b; color: #10b981; padding: 10px 15px; border-radius: 5px; font-size: 12px; z-index: 10000; border: 1px solid #10b981;';
            serverInfo.innerHTML = `
                <div style="font-weight: bold; margin-bottom: 5px;">üîó Connected to:</div>
                <div style="font-family: monospace; color: #60a5fa;">${SERVER_URL}</div>
                <div style="margin-top: 5px; font-size: 10px; color: #94a3b8;">${SERVER_URL === WORKER_URL ? '‚úÖ Cloudflare Worker' : '‚ö†Ô∏è Direct Backend'}</div>
            `;
            document.body.appendChild(serverInfo);
        });
        
        // Initial Load
        loadAllData();
        
        // Start Auto Refresh if enabled
        if (document.getElementById('autoRefresh').checked) {
            autoRefreshInterval = setInterval(loadAllData, 5000);
        }
    </script>
</body>
</html>
